<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuitBet AI</title>
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QuitBet AI">
    <link rel="manifest" href="/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #111827;
            color: #f9fafb;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #9ca3af;
            margin-bottom: 3rem;
            text-align: center;
        }
        
        .button {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            min-width: 200px;
            transition: background-color 0.3s;
        }
        
        .button:hover {
            background-color: #b91c1c;
        }
        
        .button.primary {
            background-color: #60a5fa;
        }
        
        .button.primary:hover {
            background-color: #3b82f6;
        }
        
        .card {
            background-color: #1f2937;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            max-width: 400px;
            width: 100%;
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #f9fafb;
        }
        
        .card-text {
            color: #d1d5db;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .emergency {
            background-color: #dc2626;
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .emergency h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .emergency p {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .phone-number {
            font-size: 1.3rem;
            font-weight: bold;
            background-color: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 6px;
            display: inline-block;
            color: #60a5fa;
        }
        
        .phone-number[style*="color: #dc2626"] {
            color: #dc2626 !important;
            background-color: #fef2f2 !important;
            border: 2px solid #dc2626 !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
        }
        
        .helpline-number {
            color: #dc2626 !important;
            font-weight: bold !important;
            background-color: #fef2f2 !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            border: 2px solid #dc2626 !important;
            font-size: 1.3rem !important;
            display: inline-block !important;
            margin: 4px 0 !important;
        }
        
        .grounding-exercise {
            background-color: #1f2937;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            max-width: 400px;
            width: 100%;
        }
        
        .step {
            margin: 15px 0;
            padding: 10px;
            background-color: #374151;
            border-radius: 8px;
        }
        
        .step-number {
            background-color: #60a5fa;
            color: #111827;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        /* Chat Styles */
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #374151;
            border-radius: 8px;
            position: relative;
        }
        
        .message {
            margin: 10px 0;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .ai-message {
            background-color: #4b5563;
            color: #f9fafb;
            margin-right: auto;
        }
        
        .user-message {
            background-color: #3b82f6;
            color: white;
            margin-left: auto;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            position: sticky;
            bottom: 0;
            background-color: #1f2937;
            padding: 10px 0;
            z-index: 10;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #4b5563;
            border-radius: 25px;
            background-color: #374151;
            color: #f9fafb;
            font-size: 16px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        .send-button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .send-button:hover {
            background-color: #2563eb;
        }
        
        .send-button:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
        }
        
        .thinking-message {
            background-color: #4b5563;
            color: #9ca3af;
            font-style: italic;
        }
        
        .thinking-dots {
            display: inline-block;
            animation: thinking 1.5s infinite;
        }
        
        @keyframes thinking {
            0%, 20% { opacity: 0; }
            50% { opacity: 1; }
            80%, 100% { opacity: 0; }
        }
        
        /* Gambling Counter Styles */
        .gambling-counter {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            text-align: center;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .counter-number {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .counter-label {
            font-size: 1.2rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .counter-message {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 15px;
        }
        
        .counter-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .counter-btn {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .counter-btn:hover {
            background-color: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
        
        .counter-btn.danger {
            background-color: rgba(220, 38, 38, 0.8);
            border-color: rgba(220, 38, 38, 1);
        }
        
        .counter-btn.danger:hover {
            background-color: rgba(220, 38, 38, 1);
        }
        
        /* Task button styles */
        .task-btn {
            background-color: #3b82f6 !important;
            color: white !important;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        .task-btn:hover {
            background-color: #2563eb !important;
        }
        
        .task-btn.completed {
            background-color: #6b7280 !important;
            color: #d1d5db !important;
        }
        
        .task-btn.completed:hover {
            background-color: #4b5563 !important;
        }
        
        .last-updated {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 10px;
        }
        
        /* Tasks list styles */
        .tasks-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background-color: #374151;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        .task-item.completed {
            border-left-color: #6b7280;
            opacity: 0.7;
        }
        
        .task-text {
            flex: 1;
            color: #f9fafb;
            font-size: 0.9rem;
        }
        
        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #9ca3af;
        }
        
        @media (max-width: 480px) {
            .title {
                font-size: 2rem;
            }
            
            .container {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .counter-number {
                font-size: 2.8rem;
            }
            
            .counter-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">QuitBet AI</h1>
        <p class="subtitle">Your AI-powered recovery companion</p>
        
        <div id="welcome-screen">
            <!-- Gambling-Free Counter -->
            <div class="gambling-counter">
                <div class="counter-number" id="gambling-days">0</div>
                <div class="counter-label">Days Gambling-Free</div>
                <div class="counter-message" id="motivational-message">You're taking the first step towards recovery!</div>
                <div class="counter-buttons">
                    <button class="counter-btn" onclick="resetGamblingCounter()">Reset Counter</button>
                    <button class="counter-btn" onclick="forceUpdateCounter()">Refresh</button>
                </div>
                <div class="last-updated" id="last-updated">Last updated: Just now</div>
            </div>
            
            <div class="card">
                <h2 class="card-title">Welcome to QuitBet AI</h2>
                <p class="card-text">
                    Get immediate support and guidance for gambling addiction recovery. 
                    Access crisis resources, grounding exercises, and AI-powered assistance.
                </p>
            </div>
            
            <button class="button emergency" onclick="showCrisisSupport()">
                🆘 Get Help Now
            </button>
            
            <button class="button primary" onclick="showGroundingExercise()">
                🧘 Grounding Exercise
            </button>
            
            <button class="button" onclick="showChat()">
                💬 AI Chat Support
            </button>
            
            <button class="button primary" onclick="showTasks()">
                ✅ Tasks
            </button>
        </div>
        
        <div id="crisis-screen" class="hidden">
            <div class="emergency">
                <h3>🚨 Crisis Support</h3>
                <p>If you're in immediate danger or having thoughts of self-harm:</p>
                <div class="phone-number">Call 911</div>
            </div>
            
            <div class="card">
                <h2 class="card-title">Immediate Help</h2>
                <p class="card-text">
                    <strong>National Problem Gambling Helpline:</strong><br>
                    <span class="helpline-number" style="color: #dc2626 !important; font-weight: bold !important; background-color: #fef2f2 !important; padding: 4px 8px !important; border-radius: 4px !important; border: 2px solid #dc2626 !important; font-size: 1.3rem; display: inline-block; margin: 4px 0;">1-800-522-4700</span>
                </p>
                <p class="card-text">
                    <strong>Crisis Text Line:</strong><br>
                    Text HOME to <span class="phone-number">741741</span>
                </p>
            </div>
            
            <div class="grounding-exercise">
                <h3 class="card-title">5-4-3-2-1 Grounding Exercise</h3>
                <p class="card-text">When you feel overwhelmed, use this technique:</p>
                <div class="step">
                    <span class="step-number">5</span>
                    <strong>5 things you can see</strong> - Look around and name 5 things you can see
                </div>
                <div class="step">
                    <span class="step-number">4</span>
                    <strong>4 things you can touch</strong> - Name 4 things you can feel
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <strong>3 things you can hear</strong> - Listen and name 3 sounds
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <strong>2 things you can smell</strong> - Notice 2 different scents
                </div>
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>1 thing you can taste</strong> - Focus on 1 taste in your mouth
                </div>
            </div>
            
            <button class="button primary" onclick="showWelcome()">
                ← Back to Home
            </button>
        </div>
        
        <div id="grounding-screen" class="hidden">
            <div class="grounding-exercise">
                <h2 class="card-title">5-4-3-2-1 Grounding Exercise</h2>
                <p class="card-text">
                    This technique helps you stay present and calm when you feel overwhelmed.
                    Take your time with each step.
                </p>
                
                <div class="step">
                    <span class="step-number">5</span>
                    <strong>5 things you can see</strong><br>
                    Look around and name 5 things you can see right now
                </div>
                
                <div class="step">
                    <span class="step-number">4</span>
                    <strong>4 things you can touch</strong><br>
                    Name 4 things you can feel with your hands
                </div>
                
                <div class="step">
                    <span class="step-number">3</span>
                    <strong>3 things you can hear</strong><br>
                    Listen carefully and name 3 sounds around you
                </div>
                
                <div class="step">
                    <span class="step-number">2</span>
                    <strong>2 things you can smell</strong><br>
                    Take a deep breath and notice 2 different scents
                </div>
                
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>1 thing you can taste</strong><br>
                    Focus on 1 taste in your mouth right now
                </div>
                
                <p class="card-text" style="margin-top: 20px; font-style: italic;">
                    Take 3 slow, deep breaths. You are safe. You are in control.
                </p>
            </div>
            
            <button class="button primary" onclick="showWelcome()">
                ← Back to Home
            </button>
        </div>
        
        <div id="chat-screen" class="hidden">
            <div class="card" style="height: 600px; display: flex; flex-direction: column;">
                <div style="flex-shrink: 0;">
                    <h2 class="card-title">AI Chat Support (GPT-5 Nano)</h2>
                    <div class="card-text" style="margin-bottom: 15px; font-size: 0.9rem; color: #9ca3af;">
                        Powered by GPT-5 Nano for intelligent, personalized responses
                    </div>
                </div>
                <div id="chat-messages" class="chat-messages" style="flex: 1; margin-bottom: 0; height: calc(100% - 200px);">
                    <div class="message ai-message">
                        <p>Hi! I'm here to help you with your gambling recovery journey. Ask me anything about strategies, blocking ads, managing triggers, or getting support. What's on your mind?</p>
                    </div>
                </div>
            </div>
            
            <!-- Fixed input area outside the card -->
            <div style="position: fixed; bottom: 80px; left: 20px; right: 20px; background-color: #1f2937; padding: 15px; border-radius: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); z-index: 1000;">
                <div class="chat-input-container" style="margin-top: 0;">
                    <input type="text" id="chat-input" placeholder="Type your message..." class="chat-input">
                    <button id="send-btn" onclick="sendMessage()" class="send-button">Send</button>
                </div>
                <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center;">
                    <button class="counter-btn" onclick="setApiKey()" style="font-size: 0.8rem; padding: 6px 12px;">
                        🔑 API Key
                    </button>
                    <button class="counter-btn" onclick="clearApiKey()" style="font-size: 0.8rem; padding: 6px 12px;">
                        🗑️ Clear Key
                    </button>
                </div>
            </div>
            
            <button class="button primary" onclick="showWelcome()" style="margin-top: 120px;">
                ← Back to Home
            </button>
        </div>
        
        <div id="tasks-screen" class="hidden">
            <div class="card">
                <h2 class="card-title">Daily Tasks</h2>
                <div class="card-text" style="margin-bottom: 15px; font-size: 0.9rem; color: #9ca3af;">
                    Complete these tasks to stay on track with your recovery
                </div>
                <div id="tasks-list" class="tasks-list">
                    <!-- Tasks will be populated here -->
                </div>
                <div style="margin-top: 15px;">
                    <button class="counter-btn" onclick="addNewTask()" style="font-size: 0.8rem; padding: 6px 12px;">
                        ➕ Add Task
                    </button>
                    <button class="counter-btn" onclick="resetAllTasks()" style="font-size: 0.8rem; padding: 6px 12px;">
                        🔄 Reset All
                    </button>
                </div>
            </div>
            
            <button class="button primary" onclick="showWelcome()">
                ← Back to Home
            </button>
        </div>
    </div>

    <script>
        // Gambling counter functionality
        let gamblingCounter = 0;
        let lastGamblingDate = null;
        let lastUpdateDate = null;
        
        // Tasks functionality
        let tasks = [];
        
        function initializeGamblingCounter() {
            // Load from localStorage
            const savedCounter = localStorage.getItem('endbet_gambling_days');
            const savedLastDate = localStorage.getItem('endbet_last_gambling_date');
            const savedLastUpdate = localStorage.getItem('endbet_last_update_date');
            
            if (savedCounter !== null) {
                gamblingCounter = parseInt(savedCounter);
            }
            
            if (savedLastDate !== null) {
                lastGamblingDate = new Date(savedLastDate);
            }
            
            if (savedLastUpdate !== null) {
                lastUpdateDate = new Date(savedLastUpdate);
            }
            
            // If no data exists, initialize with current date
            if (lastGamblingDate === null) {
                lastGamblingDate = new Date();
                lastUpdateDate = new Date();
                saveGamblingData();
            }
            
            updateGamblingCounter();
        }
        
        function saveGamblingData() {
            localStorage.setItem('endbet_gambling_days', gamblingCounter.toString());
            if (lastGamblingDate) {
                localStorage.setItem('endbet_last_gambling_date', lastGamblingDate.toISOString());
            }
            if (lastUpdateDate) {
                localStorage.setItem('endbet_last_update_date', lastUpdateDate.toISOString());
            }
        }
        
        function checkForDayChange() {
            const today = new Date();
            const lastUpdate = lastUpdateDate ? new Date(lastUpdateDate) : new Date();
            
            // Check if it's a new day (different date)
            if (today.toDateString() !== lastUpdate.toDateString()) {
                console.log('New day detected! Updating counter...');
                
                // Calculate days since last gambling
                const daysSinceGambling = Math.floor((today - lastGamblingDate) / (1000 * 60 * 60 * 24));
                
                // Update counter if it's been a full day
                if (daysSinceGambling > gamblingCounter) {
                    gamblingCounter = daysSinceGambling;
                    lastUpdateDate = today;
                    saveGamblingData();
                    updateGamblingCounter();
                    
                    // Show celebration for milestones
                    if (gamblingCounter === 1) {
                        alert('🎉 Congratulations! You\'ve completed your first day gambling-free!');
                    } else if (gamblingCounter === 7) {
                        alert('🌟 Amazing! You\'ve been gambling-free for a whole week!');
                    } else if (gamblingCounter === 30) {
                        alert('🏆 Incredible! You\'ve reached 30 days gambling-free!');
                    } else if (gamblingCounter === 100) {
                        alert('🎊 Outstanding! 100 days gambling-free! You\'re an inspiration!');
                    } else if (gamblingCounter % 30 === 0) {
                        alert(`🎉 Congratulations! You've reached ${gamblingCounter} days gambling-free!`);
                    }
                }
            }
        }
        
        function updateGamblingCounter() {
            document.getElementById('gambling-days').textContent = gamblingCounter;
            
            // Update motivational message
            const message = getMotivationalMessage(gamblingCounter);
            document.getElementById('motivational-message').textContent = message;
            
            // Update last updated time
            const now = new Date();
            document.getElementById('last-updated').textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }
        
        function getMotivationalMessage(days) {
            if (days === 0) {
                return "You're taking the first step towards recovery!";
            } else if (days === 1) {
                return "Amazing! You've completed your first day!";
            } else if (days < 7) {
                return `You're on day ${days}! Every day counts!`;
            } else if (days < 30) {
                return `Incredible! ${days} days strong!`;
            } else if (days < 100) {
                return `Outstanding! ${days} days of freedom!`;
            } else {
                return `You're an inspiration! ${days} days gambling-free!`;
            }
        }
        
        function resetGamblingCounter() {
            if (confirm('Are you sure you want to reset your gambling-free counter? This will set it back to 0.')) {
                gamblingCounter = 0;
                lastGamblingDate = new Date();
                lastUpdateDate = new Date();
                saveGamblingData();
                updateGamblingCounter();
                alert('Counter reset. You can start fresh!');
            }
        }
        
        function forceUpdateCounter() {
            checkForDayChange();
            alert(`Counter refreshed! Current count: ${gamblingCounter} days`);
        }
        
        // API Key management functions
        function setApiKey() {
            const currentKey = localStorage.getItem('openai_api_key');
            const newKey = prompt('Enter your OpenAI API key:', currentKey || '');
            
            if (newKey && newKey.trim()) {
                localStorage.setItem('openai_api_key', newKey.trim());
                alert('API key saved successfully! You can now use GPT-5 Nano for intelligent responses.');
            } else if (newKey === '') {
                alert('API key cleared.');
            }
        }
        
        function clearApiKey() {
            if (confirm('Are you sure you want to clear your API key? This will disable GPT-5 Nano responses.')) {
                localStorage.removeItem('openai_api_key');
                alert('API key cleared. The chatbot will use fallback responses.');
            }
        }
        
        // Screen navigation functions
        function showCrisisSupport() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('crisis-screen').classList.remove('hidden');
            document.getElementById('grounding-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
        }
        
        function showGroundingExercise() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('crisis-screen').classList.add('hidden');
            document.getElementById('grounding-screen').classList.remove('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
        }
        
        function showChat() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('crisis-screen').classList.add('hidden');
            document.getElementById('grounding-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');
        }
        
        function showWelcome() {
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('crisis-screen').classList.add('hidden');
            document.getElementById('grounding-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('tasks-screen').classList.add('hidden');
            
            // Check for day changes when returning to main screen
            checkForDayChange();
        }
        
        function showTasks() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('crisis-screen').classList.add('hidden');
            document.getElementById('grounding-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('tasks-screen').classList.remove('hidden');
            
            // Load and display tasks
            loadTasks();
            updateTasksList();
        }
        
        // Chatbot functionality
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Disable input while AI is thinking
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            input.disabled = true;
            
            // Show thinking animation
            addThinkingMessage();
            
            try {
                // Generate AI response using GPT-5 nano
                const response = await getAIResponse(message);
                removeThinkingMessage();
                addChatMessage(response, 'ai');
            } catch (error) {
                console.error('Error getting AI response:', error);
                removeThinkingMessage();
                addChatMessage("I'm sorry, I'm having trouble connecting to the AI service right now. Please try again in a moment.", 'ai');
            } finally {
                // Re-enable input
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }
        
        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = `<p>${message}</p>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addThinkingMessage() {
            const chatMessages = document.getElementById('chat-messages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message thinking-message';
            thinkingDiv.id = 'thinking-message';
            thinkingDiv.innerHTML = '<p>AI is thinking<span class="thinking-dots">...</span></p>';
            chatMessages.appendChild(thinkingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function removeThinkingMessage() {
            const thinkingMessage = document.getElementById('thinking-message');
            if (thinkingMessage) {
                thinkingMessage.remove();
            }
        }
        
        async function getAIResponse(userMessage) {
            try {
                // Get API key from environment or prompt user
                let apiKey = localStorage.getItem('openai_api_key');
                
                if (!apiKey) {
                    apiKey = prompt('Please enter your OpenAI API key:');
                    if (apiKey) {
                        localStorage.setItem('openai_api_key', apiKey);
                    } else {
                        return "I need an OpenAI API key to provide AI-powered responses. Please enter your API key when prompted.";
                    }
                }
                
                // Create the API request
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-nano',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a supportive AI assistant specialized in helping people recover from gambling addiction. You provide specific, actionable advice, emotional support, and practical strategies. You're knowledgeable about:

- Blocking gambling ads and websites (specific apps, browser extensions, router settings)
- Gambling recovery strategies and barriers
- Financial protection methods
- Trigger management and replacement activities
- Support resources (Gamblers Anonymous, helplines, counseling)
- Crisis support and grounding techniques
- Emotional support and coping strategies

Always be specific, practical, and encouraging. Provide step-by-step instructions when possible. Use emojis and formatting to make responses clear and engaging.`
                            },
                            {
                                role: 'user',
                                content: userMessage
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error('Invalid response format from API');
                }
                
            } catch (error) {
                console.error('Error calling GPT-5 nano API:', error);
                
                // Fallback to rule-based responses if API fails
                return getFallbackResponse(userMessage);
            }
        }
        
        function getFallbackResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Specific responses for blocking gambling ads
            if (message.includes('block') && (message.includes('ad') || message.includes('advertisement'))) {
                return "Here's exactly how to block gambling ads:\n\n📱 **MOBILE DEVICES:**\n• **iOS:** Settings > Screen Time > Content & Privacy > Content Restrictions > Web Content > Limit Adult Websites\n• **Android:** Use apps like 'BlockSite' or 'AdGuard' from Play Store\n• **Safari:** Settings > Safari > Content Blockers > Enable ad blockers\n\n💻 **COMPUTERS:**\n• **Chrome/Edge:** Install 'uBlock Origin' or 'AdBlock Plus' extensions\n• **Firefox:** Install 'uBlock Origin' or 'AdNauseam'\n• **Router Level:** Configure OpenDNS or similar to block gambling domains\n\n🎯 **SPECIFIC GAMBLING SITES:**\n• Add these to your block list: *.bet365.com, *.pokerstars.com, *.casino.com, *.sportsbook.com\n• Use parental control software like 'Qustodio' or 'Circle Home Plus'\n\nWhich device are you using? I can give you step-by-step instructions!";
            }
            
            // Gambling recovery strategies
            if (message.includes('gambl') || message.includes('bet') || message.includes('casino') || message.includes('poker') || message.includes('slots')) {
                return "Here are proven strategies to stop gambling:\n\n🚫 **IMMEDIATE BARRIERS:**\n• Block all gambling sites and apps on every device\n• Use Gamban or BetBlocker apps\n• Give someone else control of your money\n• Delete all gambling-related apps and bookmarks\n\n🎯 **TRIGGER MANAGEMENT:**\n• Identify what makes you want to gamble (stress, boredom, ads)\n• Create a specific plan for each trigger\n• Replace gambling with healthy activities\n• Avoid places where you used to gamble\n\n💪 **REPLACEMENT ACTIVITIES:**\n• Exercise, sports, or physical activities\n• Hobbies like reading, art, music, or crafts\n• Social activities with friends and family\n• Learning new skills or taking classes\n\nWhat's your biggest trigger? Let's create a specific plan!";
            }
            
            // Emotional support
            if (message.includes('sad') || message.includes('depressed') || message.includes('anxious') || message.includes('stressed') || message.includes('overwhelmed')) {
                return "I hear that you're feeling overwhelmed. These feelings are valid and temporary. Here's what can help:\n\n🧘 **IMMEDIATE RELIEF:**\n• Take 5 deep breaths - in for 4 counts, hold for 4, out for 6\n• Use the 5-4-3-2-1 grounding technique\n• Call a trusted friend or family member\n• Go for a short walk outside\n\n💪 **COPING STRATEGIES:**\n• Write down your feelings in a journal\n• Practice mindfulness or meditation\n• Listen to calming music\n• Do something creative (draw, write, craft)\n\n🤝 **GET SUPPORT:**\n• Text HOME to 741741 for crisis support\n• Call 1-800-522-4700 for gambling helpline\n• Reach out to a trusted person\n• Consider professional counseling\n\nYou don't have to face this alone. What's one small thing that usually helps you feel better?";
            }
            
            // General support and encouragement
            return "I'm here to support you through your recovery journey. Every step forward, no matter how small, is progress. What would be most helpful for you right now?";
        }
        
        // Tasks functionality
        function loadTasks() {
            const savedTasks = localStorage.getItem('endbet_tasks');
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            } else {
                // Initialize with default tasks
                tasks = [
                    { id: 1, text: 'Write in journal', completed: false },
                    { id: 2, text: 'Call a support contact', completed: false },
                    { id: 3, text: 'Complete grounding exercise', completed: false },
                    { id: 4, text: 'Block gambling websites', completed: false },
                    { id: 5, text: 'Read recovery materials', completed: false }
                ];
                saveTasks();
            }
        }
        
        function saveTasks() {
            localStorage.setItem('endbet_tasks', JSON.stringify(tasks));
        }
        
        function updateTasksList() {
            const tasksList = document.getElementById('tasks-list');
            tasksList.innerHTML = '';
            
            console.log('Updating tasks list with', tasks.length, 'tasks');
            
            tasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = `task-item ${task.completed ? 'completed' : ''}`;
                
                const buttonText = task.completed ? 'Done' : 'Mark Done';
                const buttonStyle = task.completed 
                    ? 'background-color: #6b7280 !important; color: #d1d5db !important; border: none; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; margin-left: 10px;'
                    : 'background-color: #3b82f6 !important; color: white !important; border: none; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; margin-left: 10px;';
                
                console.log(`Task ${task.id}: completed=${task.completed}, style=${buttonStyle}`);
                
                taskDiv.innerHTML = `
                    <span class="task-text">${task.text}</span>
                    <button style="${buttonStyle}" onclick="toggleTask(${task.id})">
                        ${buttonText}
                    </button>
                `;
                
                tasksList.appendChild(taskDiv);
            });
        }
        
        function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                saveTasks();
                updateTasksList();
            }
        }
        
        function addNewTask() {
            const taskText = prompt('Enter new task:');
            if (taskText && taskText.trim()) {
                const newTask = {
                    id: Math.max(...tasks.map(t => t.id), 0) + 1,
                    text: taskText.trim(),
                    completed: false
                };
                tasks.push(newTask);
                saveTasks();
                updateTasksList();
            }
        }
        
        function resetAllTasks() {
            if (confirm('Are you sure you want to reset all tasks to incomplete?')) {
                tasks.forEach(task => {
                    task.completed = false;
                });
                saveTasks();
                updateTasksList();
            }
        }
        
        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize gambling counter
            initializeGamblingCounter();
            
            // Initialize tasks
            loadTasks();
            
            // Set up periodic checking for day changes (every 5 minutes)
            setInterval(checkForDayChange, 5 * 60 * 1000);
            
            // Allow Enter key to send messages
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            // Make phone numbers clickable
            const phoneNumbers = document.querySelectorAll('.phone-number');
            phoneNumbers.forEach(phone => {
                phone.style.cursor = 'pointer';
                phone.onclick = function() {
                    const number = this.textContent.replace(/\D/g, '');
                    window.location.href = `tel:${number}`;
                };
            });
        });
    </script>
</body>
</html>